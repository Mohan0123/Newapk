<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ranginx - Watch Movies & Series</title>
    
    <meta name="description" content="Watch latest HD movies and web series on Ranginx.">
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <link rel="stylesheet" href="https://cdn.plyr.io/3.7.8/plyr.css" />
    <script src="https://cdn.plyr.io/3.7.8/plyr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/hls.js@1.4.0/dist/hls.min.js"></script>

    <script>
        // Force Dark Theme
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: { 
                        brand: '#e50914', 
                        dark: { bg: '#000000', card: '#111111', border: '#222222' }
                    }
                }
            }
        }
    </script>

    <style>
        body { background-color: #000; color: #fff; font-family: sans-serif; }
        
        /* Glass Navbar */
        .glass-nav { 
            background: rgba(0,0,0,0.8); 
            backdrop-filter: blur(10px); 
            border-bottom: 1px solid #222; 
        }

        /* Player Customization */
        :root { --plyr-color-main: #e50914; }
        
        /* Hide Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 4px; }
        
        /* Loader */
        .loader { border: 3px solid #333; border-top: 3px solid #e50914; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body>

<nav class="fixed top-0 w-full h-16 glass-nav z-50 flex items-center justify-between px-4 lg:px-8">
    <a href="/" class="spa-link text-2xl font-bold text-brand tracking-tighter">Ranginx</a>
    <div class="hidden md:flex gap-6 text-sm text-gray-400 font-medium">
        <a href="/" class="spa-link hover:text-white transition">Home</a>
        <a href="/" onclick="filterContent('movie')" class="hover:text-white transition cursor-pointer">Movies</a>
        <a href="/" onclick="filterContent('series')" class="hover:text-white transition cursor-pointer">Series</a>
    </div>
    <div class="relative hidden md:block w-64">
        <input type="text" id="search-input" placeholder="Search..." class="w-full bg-[#111] border border-[#222] pl-10 pr-4 py-1.5 rounded-full text-sm focus:border-brand outline-none text-white">
        <i data-lucide="search" class="w-4 h-4 text-gray-500 absolute left-3.5 top-2"></i>
    </div>
</nav>

<main id="app" class="pt-20 min-h-screen pb-12 px-4 md:px-8 max-w-[1600px] mx-auto"></main>

<script>
    const STATE = { data: [], player: null, hls: null };

    // --- INIT ---
    document.addEventListener('DOMContentLoaded', async () => {
        // SPA Link Handler
        document.body.addEventListener('click', e => {
            const link = e.target.closest('a.spa-link');
            if (link) { e.preventDefault(); history.pushState(null, '', link.href); router(); }
        });

        // Search
        document.getElementById('search-input').addEventListener('keyup', (e) => {
            if(!e.target.value) renderHome(STATE.data);
            else renderHome(STATE.data.filter(i => i.title.toLowerCase().includes(e.target.value.toLowerCase())));
        });

        lucide.createIcons();
        await loadData();
    });

    window.addEventListener('popstate', router);

    // --- DATA LOADER ---
    async function loadData() {
        document.getElementById('app').innerHTML = `<div class="h-[80vh] flex justify-center items-center"><div class="loader"></div></div>`;
        try {
            const res = await fetch('data/normal.json');
            if (!res.ok) throw new Error("JSON not found");
            const json = await res.json();
            STATE.data = json.reverse();
            router();
        } catch (e) {
            document.getElementById('app').innerHTML = `<div class="text-center mt-20 text-gray-500">Error loading content. Ensure /data/normal.json exists.</div>`;
        }
    }

    // --- ROUTER ---
    function router() {
        window.scrollTo(0, 0);
        destroyPlayer();
        const path = window.location.pathname;
        const slug = path.substring(1);

        if (path === '/' || path === '/index.html' || path === '') {
            renderHome(STATE.data);
        } else {
            const item = STATE.data.find(i => i.slug === slug);
            if (item) renderWatch(item);
            else renderHome(STATE.data); // Fallback to home instead of 404
        }
    }

    // --- RENDER HOME ---
    function renderHome(list) {
        let html = '';
        
        // Featured
        if(list[0] && !document.getElementById('search-input').value) {
            html += `
            <div class="relative w-full aspect-video md:aspect-[21/9] rounded-xl overflow-hidden mb-10 group border border-[#222]">
                <div class="absolute inset-0 bg-cover bg-center" style="background-image: url('${list[0].thumbnail}');"></div>
                <div class="absolute inset-0 bg-gradient-to-t from-black via-black/60 to-transparent"></div>
                <div class="absolute bottom-0 left-0 p-6 md:p-12 w-full md:w-2/3">
                    <h1 class="text-3xl md:text-6xl font-bold text-white mb-4 drop-shadow-xl">${list[0].title}</h1>
                    <p class="text-gray-300 line-clamp-2 mb-6 text-sm md:text-lg max-w-xl">${list[0].description || ''}</p>
                    <a href="/${list[0].slug}" class="spa-link bg-brand text-white px-8 py-3 rounded font-bold hover:bg-red-700 transition inline-flex items-center gap-2">
                        <i data-lucide="play" class="w-5 h-5 fill-current"></i> Play Now
                    </a>
                </div>
            </div>`;
        }

        // Grid
        html += `<div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">`;
        list.forEach(item => {
            html += `
            <a href="/${item.slug}" class="spa-link group">
                <div class="aspect-[2/3] rounded-lg overflow-hidden mb-2 relative border border-[#222] bg-[#111]">
                    <img src="${item.thumbnail}" class="w-full h-full object-cover group-hover:scale-105 transition duration-500 opacity-80 group-hover:opacity-100">
                    <div class="absolute inset-0 flex items-center justify-center opacity-0 group-hover:opacity-100 transition">
                        <div class="bg-brand/90 p-3 rounded-full shadow-lg"><i data-lucide="play" class="w-6 h-6 fill-white text-white"></i></div>
                    </div>
                </div>
                <h3 class="font-medium text-sm text-gray-200 line-clamp-1 group-hover:text-brand">${item.title}</h3>
                <div class="flex justify-between text-[11px] text-gray-500 mt-1">
                    <span>${item.date || '2025'}</span>
                    <span class="uppercase border border-[#333] px-1 rounded">${item.category || 'HD'}</span>
                </div>
            </a>`;
        });
        html += `</div>`;
        
        document.getElementById('app').innerHTML = html;
        lucide.createIcons();
    }

    // --- RENDER WATCH ---
    function renderWatch(item) {
        const isSeries = item.episodes && item.episodes.length > 0;
        const src = isSeries ? item.episodes[0].url : item.video;
        const title = isSeries ? `${item.title} - Episode 1` : item.title;

        // Auto SEO
        document.title = `Watch ${item.title}`;

        let html = `
        <div class="animate-fade">
            <div class="flex flex-col lg:flex-row gap-8">
                <div class="w-full lg:w-[75%]">
                    <div class="aspect-video w-full bg-black rounded-xl overflow-hidden border border-[#222] shadow-2xl relative">
                        <video id="player" controls crossorigin playsinline poster="${item.thumbnail}" class="w-full h-full"></video>
                    </div>
                    
                    <div class="mt-4">
                        <h1 id="vid-title" class="text-2xl md:text-3xl font-bold text-white mb-2">${title}</h1>
                        <div class="flex gap-3 text-xs text-gray-400 mb-4">
                            <span class="bg-[#222] px-2 py-0.5 rounded text-white border border-[#333]">HD</span>
                            <span>${item.category || 'General'}</span>
                        </div>
                        <div class="bg-[#111] p-6 rounded-xl border border-[#222] text-gray-300 text-sm leading-relaxed">
                            ${item.description || 'No description available.'}
                        </div>
                    </div>

                    ${isSeries ? `
                    <div class="mt-8">
                        <h3 class="text-lg font-bold text-white mb-4">Episodes</h3>
                        <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-5 gap-2">
                            ${item.episodes.map((ep, idx) => `
                                <button onclick="playSource('${ep.url}', '${item.title} - Ep ${ep.ep}', this)" 
                                    class="ep-btn ${idx===0 ? 'bg-brand text-white border-brand' : 'bg-[#111] text-gray-400 border-[#222] hover:bg-[#222]'} 
                                    border p-3 rounded text-sm transition truncate">
                                    Ep ${ep.ep}
                                </button>
                            `).join('')}
                        </div>
                    </div>` : ''}
                </div>

                <div class="w-full lg:w-[25%]">
                    <h3 class="text-lg font-bold text-white mb-4 pl-3 border-l-4 border-brand">More Like This</h3>
                    <div class="flex flex-col gap-3">
                        ${STATE.data.filter(i => i.slug !== item.slug).slice(0, 6).map(s => `
                        <a href="/${s.slug}" class="spa-link flex gap-3 p-2 rounded hover:bg-[#111] transition group">
                            <div class="w-20 aspect-[2/3] bg-[#222] rounded overflow-hidden flex-shrink-0">
                                <img src="${s.thumbnail}" class="w-full h-full object-cover">
                            </div>
                            <div class="flex flex-col justify-center">
                                <h4 class="text-sm font-bold text-gray-200 line-clamp-2 group-hover:text-brand">${s.title}</h4>
                                <span class="text-xs text-gray-500 mt-1">${s.category || 'Movie'}</span>
                            </div>
                        </a>`).join('')}
                    </div>
                </div>
            </div>
        </div>`;

        document.getElementById('app').innerHTML = html;
        initPlayer(src);
        lucide.createIcons();
    }

    // --- PLAYER LOGIC ---
    function destroyPlayer() {
        if (STATE.hls) { STATE.hls.destroy(); STATE.hls = null; }
        if (STATE.player) { STATE.player.destroy(); STATE.player = null; }
    }

    function initPlayer(source) {
        const video = document.getElementById('player');
        if(!video) return;

        const defaultOptions = {
            controls: ['play-large', 'play', 'progress', 'current-time', 'mute', 'volume', 'settings', 'fullscreen'],
            settings: ['quality', 'speed']
        };

        // Check if Iframe (YouTube/Embed)
        if (!source.includes('.mp4') && !source.includes('.m3u8') && source.includes('http')) {
             const parent = video.parentElement;
             parent.innerHTML = `<iframe src="${source}" class="w-full h-full border-0" allowfullscreen></iframe>`;
             return;
        }

        // Check HLS
        if (Hls.isSupported() && source.includes('.m3u8')) {
            const hls = new Hls();
            hls.loadSource(source);
            hls.attachMedia(video);
            hls.on(Hls.Events.MANIFEST_PARSED, () => {
                STATE.player = new Plyr(video, {
                    ...defaultOptions,
                    quality: { default: 720, options: [1080, 720, 480], forced: true, onChange: (q) => updateQuality(q) }
                });
            });
            STATE.hls = hls;
            
            function updateQuality(newQuality) {
                STATE.hls.levels.forEach((level, levelIndex) => {
                    if (level.height === newQuality) STATE.hls.currentLevel = levelIndex;
                });
            }
        } else {
            // Standard MP4
            video.src = source;
            STATE.player = new Plyr(video, defaultOptions);
        }
    }

    window.playSource = (url, title, btn) => {
        document.getElementById('vid-title').innerText = title;
        document.querySelectorAll('.ep-btn').forEach(b => {
            b.className = 'ep-btn bg-[#111] text-gray-400 border border-[#222] hover:bg-[#222] p-3 rounded text-sm transition truncate';
        });
        btn.className = 'ep-btn bg-brand text-white border border-brand p-3 rounded text-sm transition truncate';
        
        // Soft Destroy & Re-init
        destroyPlayer();
        // Reset Video Element if it was replaced by iframe
        const container = document.querySelector('.aspect-video');
        if(!container.querySelector('video')) {
            container.innerHTML = `<video id="player" controls crossorigin playsinline class="w-full h-full"></video>`;
        }
        
        initPlayer(url);
        window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    window.filterContent = (type) => {
        if(!type) renderHome(STATE.data);
        else renderHome(STATE.data.filter(i => i.type && i.type.toLowerCase().includes(type.toLowerCase())));
    }
</script>
</body>
</html>
